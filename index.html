<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰²åˆè¨ˆç®—ãƒ„ãƒ¼ãƒ«</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* èƒŒæ™¯è‰² */
        }
        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #4f46e5; /* ç´«è‰² */
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ef4444; /* èµ¤è‰² */
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.show {
            display: block;
            opacity: 1;
        }

        /* ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã¨ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ */
        .mode-button {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            border: 2px solid transparent; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é€æ˜ãªæ ç·š */
        }

        /* ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ */
        #mode1Btn.selected {
            background-color: #bfdbfe; /* blue-200 */
            color: #2563eb; /* blue-700 */
            border-color: #2563eb; /* blue-700 */
        }
        #mode2Btn.selected {
            background-color: #c7d2fe; /* indigo-200 */
            color: #4338ca; /* indigo-700 */
            border-color: #4338ca; /* indigo-700 */
        }
        #mode3Btn.selected {
            background-color: #e9d5ff; /* purple-200 */
            color: #7c3aed; /* purple-700 */
            border-color: #7c3aed; /* purple-700 */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-4xl border border-gray-200 relative">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">ğŸ“Š å‰²åˆè¨ˆç®—ãƒ„ãƒ¼ãƒ«</h1>

        <!-- ä½¿ã„æ–¹ãƒœã‚¿ãƒ³ -->
        <button id="helpButton" class="absolute top-4 right-4 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg shadow-sm hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75">
            ä½¿ã„æ–¹
        </button>

        <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒœã‚¿ãƒ³ -->
        <div class="flex flex-wrap justify-center gap-3 mb-8">
            <button id="mode1Btn" class="px-5 py-2 rounded-lg bg-blue-600 text-white font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 mode-button">
                ç·é‡ã¨å‰²åˆã‹ã‚‰é‡ã‚’ç®—å‡º
            </button>
            <button id="mode2Btn" class="px-5 py-2 rounded-lg bg-indigo-600 text-white font-semibold shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 mode-button">
                å‰²åˆã¨1é …ç›®ã‹ã‚‰ä»–ã‚’ç®—å‡º
            </button>
            <button id="mode3Btn" class="px-5 py-2 rounded-lg bg-purple-600 text-white font-semibold shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 mode-button">
                å„é …ç›®ã‹ã‚‰ç·é‡ã¨å‰²åˆã‚’ç®—å‡º
            </button>
        </div>

        <!-- å‰²åˆå…¥åŠ›å½¢å¼é¸æŠ -->
        <div class="flex justify-center gap-6 mb-6">
            <label class="inline-flex items-center">
                <input type="radio" name="ratioInputType" value="percentage" checked class="form-radio h-5 w-5 text-blue-600" id="radioPercentage">
                <span class="ml-2 text-gray-700 text-lg font-medium">å‰²åˆ(%)ã§å…¥åŠ›</span>
            </label>
            <label class="inline-flex items-center">
                <input type="radio" name="ratioInputType" value="ratio" class="form-radio h-5 w-5 text-purple-600" id="radioRatio">
                <span class="ml-2 text-gray-700 text-lg font-medium">æ¯”ç‡(x:y)ã§å…¥åŠ›</span>
            </label>
        </div>

        <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div id="inputArea" class="space-y-6 mb-8">
            <!-- ç·é‡å…¥åŠ› (ãƒ¢ãƒ¼ãƒ‰1, 2ã§è¡¨ç¤º) -->
            <div id="totalInputGroup" class="flex flex-col sm:flex-row items-center gap-4 bg-blue-50 p-4 rounded-lg shadow-sm">
                <label for="totalQuantity" class="text-lg font-medium text-gray-700 w-24">ç·é‡:</label>
                <!-- focus:ringã¨focus:borderã®ã‚¯ãƒ©ã‚¹ã¯JSã§å‹•çš„ã«åˆ¶å¾¡ -->
                <input type="number" id="totalQuantity" class="flex-grow p-2 border rounded-md text-lg" placeholder="ç·é‡ã‚’å…¥åŠ›">
                <input type="range" id="totalQuantitySlider" min="0" max="1000" value="100" class="w-full sm:w-48 h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
            </div>

            <!-- é …ç›®ãƒªã‚¹ãƒˆ -->
            <div id="itemsContainer" class="space-y-4">
                <!-- é …ç›®ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>

            <!-- é …ç›®è¿½åŠ ãƒœã‚¿ãƒ³ -->
            <div class="flex justify-center gap-4 mt-6">
                <button id="addItemBtn" class="px-6 py-3 rounded-lg bg-green-500 text-white font-semibold shadow-md hover:bg-green-600 transition-colors flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    é …ç›®ã‚’è¿½åŠ 
                </button>
            </div>
        </div>

        <!-- å††ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="flex flex-col lg:flex-row items-center justify-center gap-8 mt-8">
            <div class="w-full lg:w-1/2 flex justify-center">
                <canvas id="pieChart" class="bg-gray-50 rounded-xl shadow-inner border border-gray-200" width="400" height="400"></canvas>
            </div>
            <div id="chartDetails" class="w-full lg:w-1/2 bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200 text-gray-700 text-lg">
                <h3 class="text-xl font-semibold mb-4 text-center">å††ã‚°ãƒ©ãƒ•è©³ç´°</h3>
                <p id="selectedSliceInfo" class="text-center">ã‚°ãƒ©ãƒ•ã®é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            </div>
        </div>
    </div>

    <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ -->
    <div id="messageBox" class="message-box"></div>

    <!-- Modal Structure -->
    <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto relative">
            <button id="closeModalButton" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold focus:outline-none">
                &times;
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ãƒ„ãƒ¼ãƒ«ã®ä½¿ã„æ–¹</h2>
            <div class="text-gray-700 space-y-4">
                <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€å°å­¦ç”Ÿãƒ»ä¸­å­¦ç”ŸãŒå‰²åˆã®è¨ˆç®—ã‚’æ¥½ã—ãå­¦ã¹ã‚‹ã‚ˆã†ã«ä½œã‚‰ã‚Œã¦ã„ã¾ã™ã€‚</p>

                <h3 class="text-xl font-semibold text-gray-800">1. è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ã®é¸æŠ</h3>
                <p>ä¸Šéƒ¨ã«ã‚ã‚‹3ã¤ã®ãƒœã‚¿ãƒ³ã§ã€è¨ˆç®—ã—ãŸã„å†…å®¹ã«åˆã‚ã›ã¦ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚é¸æŠä¸­ã®ãƒ¢ãƒ¼ãƒ‰ã¯èƒŒæ™¯è‰²ãŒè–„ããªã‚Šã€æ–‡å­—è‰²ãŒæ¿ƒããªã‚Šã¾ã™ã€‚</p>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li><strong>ç·é‡ã¨å‰²åˆã‹ã‚‰é‡ã‚’ç®—å‡º:</strong> å…¨ä½“ã®é‡ã¨å„é …ç›®ã®å‰²åˆï¼ˆã¾ãŸã¯æ¯”ç‡ï¼‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãã‚Œãã‚Œã®é …ç›®ã®é‡ãŒè¨ˆç®—ã•ã‚Œã¾ã™ã€‚</li>
                    <li><strong>å‰²åˆã¨1é …ç›®ã‹ã‚‰ä»–ã‚’ç®—å‡º:</strong> å„é …ç›®ã®å‰²åˆï¼ˆã¾ãŸã¯æ¯”ç‡ï¼‰ã¨ã€ã„ãšã‚Œã‹1ã¤ã®é …ç›®ã®é‡ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€æ®‹ã‚Šã®é …ç›®ã®é‡ã¨å…¨ä½“ã®é‡ãŒè¨ˆç®—ã•ã‚Œã¾ã™ã€‚</li>
                    <li><strong>å„é …ç›®ã‹ã‚‰ç·é‡ã¨å‰²åˆã‚’ç®—å‡º:</strong> å„é …ç›®ã®é‡ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€å…¨ä½“ã®é‡ã¨ãã‚Œãã‚Œã®é …ç›®ã®å‰²åˆï¼ˆãŠã‚ˆã³æ¯”ç‡ï¼‰ãŒè¨ˆç®—ã•ã‚Œã¾ã™ã€‚</li>
                </ul>

                <h3 class="text-xl font-semibold text-gray-800">2. å‰²åˆå…¥åŠ›å½¢å¼ã®é¸æŠ</h3>
                <p>ã€Œå‰²åˆ(%)ã§å…¥åŠ›ã€ã¾ãŸã¯ã€Œæ¯”ç‡(x:y)ã§å…¥åŠ›ã€ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§ã€å‰²åˆã®å…¥åŠ›æ–¹æ³•ã‚’é¸ã¹ã¾ã™ã€‚</p>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li><strong>å‰²åˆ(%)ã§å…¥åŠ›:</strong> å„é …ç›®ã®å‰²åˆã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã§ç›´æ¥å…¥åŠ›ã—ã¾ã™ã€‚åˆè¨ˆãŒ100%ã§ãªã„å ´åˆã¯è‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™ã€‚</li>
                    <li><strong>æ¯”ç‡(x:y)ã§å…¥åŠ›:</strong> å„é …ç›®ã®æ¯”ç‡ï¼ˆä¾‹: 1, 2, 3ãªã©ï¼‰ã‚’å€‹åˆ¥ã®æ•°å€¤ã§å…¥åŠ›ã—ã¾ã™ã€‚ãƒ„ãƒ¼ãƒ«ãŒè‡ªå‹•çš„ã«å…¨ä½“ã®æ¯”ç‡ã‹ã‚‰ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚’è¨ˆç®—ã—ã¾ã™ã€‚</li>
                </ul>

                <h3 class="text-xl font-semibold text-gray-800">3. æ•°å€¤ã®å…¥åŠ›ã¨èª¿æ•´</h3>
                <p>é¸æŠã—ãŸãƒ¢ãƒ¼ãƒ‰ã¨å…¥åŠ›å½¢å¼ã«å¿œã˜ã¦ã€å…¥åŠ›å¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç™½è‰²ã«ãªã‚Šã€ç›´æ¥ç·¨é›†ã§ãã¾ã™ã€‚è¨ˆç®—çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ç°è‰²ã«ãªã‚Šã€ç›´æ¥ç·¨é›†ã§ãã¾ã›ã‚“ã€‚</p>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li>æ•°å€¤ã‚’ç›´æ¥å…¥åŠ›ã™ã‚‹ã‹ã€æ¨ªã®ã‚¹ãƒ©ã‚¤ãƒ‰ãƒãƒ¼ã‚’å‹•ã‹ã—ã¦èª¿æ•´ã§ãã¾ã™ã€‚</li>
                    <li>å…¥åŠ›ä¸å¯ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é¸æŠï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰ã—ãŸå ´åˆã§ã‚‚ã€æ ç·šã¯ç°è‰²ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                </ul>

                <h3 class="text-xl font-semibold text-gray-800">4. é …ç›®ã®ç®¡ç†</h3>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li>ã€Œé …ç›®ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã§ã€è¨ˆç®—å¯¾è±¡ã®é …ç›®ã‚’å¢—ã‚„ã›ã¾ã™ã€‚</li>
                    <li>å„é …ç›®ã®å³ç«¯ã«ã‚ã‚‹ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®é …ç›®ã®ã¿ã‚’å‰Šé™¤ã§ãã¾ã™ã€‚ï¼ˆæœ€ä½1é …ç›®ã¯å¿…é ˆã§ã™ã€‚ï¼‰</li>
                    <li>å„é …ç›®ã®å·¦å´ã«ã‚ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã§ã€é …ç›®åã‚’è‡ªç”±ã«è¨­å®šã§ãã¾ã™ã€‚</li>
                </ul>

                <h3 class="text-xl font-semibold text-gray-800">5. çµæœã®ç¢ºèªã¨ã‚°ãƒ©ãƒ•</h3>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li>å…¥åŠ›ã™ã‚‹ãŸã³ã«ã€è¨ˆç®—çµæœãŒè‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã€å³å´ã®å††ã‚°ãƒ©ãƒ•ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                    <li>å††ã‚°ãƒ©ãƒ•ã®ç‰¹å®šã®é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®é …ç›®ã®å…·ä½“çš„ãªé‡ã¨å‰²åˆãŒã€Œå††ã‚°ãƒ©ãƒ•è©³ç´°ã€ã‚¨ãƒªã‚¢ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                </ul>
                <p class="mt-4">ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ã€å‰²åˆã®è¨ˆç®—ã‚’æ¥½ã—ããƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ã‚‡ã†ï¼</p>
            </div>
        </div>
    </div>

    <script>
        const mode1Btn = document.getElementById('mode1Btn');
        const mode2Btn = document.getElementById('mode2Btn');
        const mode3Btn = document.getElementById('mode3Btn');
        const modeButtons = document.querySelectorAll('.mode-button'); // å…¨ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’å–å¾—

        const radioPercentage = document.getElementById('radioPercentage');
        const radioRatio = document.getElementById('radioRatio');
        const totalInputGroup = document.getElementById('totalInputGroup');
        const totalQuantityInput = document.getElementById('totalQuantity');
        const totalQuantitySlider = document.getElementById('totalQuantitySlider');
        const itemsContainer = document.getElementById('itemsContainer');
        const addItemBtn = document.getElementById('addItemBtn');

        const pieChartCanvas = document.getElementById('pieChart');
        const ctx = pieChartCanvas.getContext('2d');
        pieChartCanvas.slices = []; // Fix: Initialize slices array to prevent TypeError

        const selectedSliceInfo = document.getElementById('selectedSliceInfo');
        const messageBox = document.getElementById('messageBox');

        // ä½¿ã„æ–¹ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        const helpButton = document.getElementById('helpButton');
        const helpModal = document.getElementById('helpModal');
        const closeModalButton = document.getElementById('closeModalButton');

        let currentMode = 1; // 1: ç·é‡ã¨å‰²åˆã‹ã‚‰é‡ã‚’ç®—å‡º, 2: å‰²åˆã¨1é …ç›®ã‹ã‚‰ä»–ã‚’ç®—å‡º, 3: å„é …ç›®ã‹ã‚‰ç·é‡ã¨å‰²åˆã‚’ç®—å‡º
        let currentRatioInputType = 'percentage'; // 'percentage' or 'ratio'

        // items: { id: number, label: string, quantity: number, percentage: number, ratioPart: number }
        let items = [];

        // åˆæœŸé …ç›®è¨­å®š
        function initializeItems() {
            items = [
                { id: 1, label: 'é …ç›®1', quantity: 0, percentage: 50, ratioPart: 1 },
                { id: 2, label: 'é …ç›®2', quantity: 0, percentage: 50, ratioPart: 1 }
            ];
            renderItems();
            updateUI(); // åˆæœŸUIæ›´æ–°
            calculate();
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showMessage(message, type = 'error', duration = 3000) {
            messageBox.textContent = message;
            messageBox.style.backgroundColor = type === 'error' ? '#ef4444' : '#22c55e'; // èµ¤ or ç·‘
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        // é …ç›®ã®HTMLã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderItems() {
            itemsContainer.innerHTML = ''; // ä¸€åº¦ã‚¯ãƒªã‚¢ã—ã¦å†æç”»
            items.forEach((item) => {
                const itemDiv = document.createElement('div');
                itemDiv.id = `item-${item.id}`;
                itemDiv.className = 'flex flex-col sm:flex-row items-center gap-4 bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200';
                itemDiv.innerHTML = `
                    <input type="text" id="itemLabel-${item.id}" value="${item.label}" class="w-full sm:w-32 p-2 border border-gray-300 rounded-md focus:ring-gray-500 focus:border-gray-500 text-lg" placeholder="é …ç›®å">
                    <div class="flex-grow flex items-center gap-2">
                        <label for="itemQuantity-${item.id}" class="text-gray-700 text-lg">é‡:</label>
                        <input type="number" id="itemQuantity-${item.id}" value="${item.quantity}" class="w-24 p-2 border rounded-md text-lg item-quantity-input">
                        <input type="range" id="itemQuantitySlider-${item.id}" min="0" max="500" value="${item.quantity}" class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer item-quantity-slider">
                    </div>
                    <div class="flex-grow flex items-center gap-2 item-percentage-group">
                        <label for="itemPercentage-${item.id}" class="text-gray-700 text-lg">å‰²åˆ (%):</label>
                        <input type="number" id="itemPercentage-${item.id}" value="${item.percentage}" class="w-24 p-2 border rounded-md text-lg item-percentage-input">
                        <input type="range" id="itemPercentageSlider-${item.id}" min="0" max="100" value="${item.percentage}" class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer item-percentage-slider">
                    </div>
                    <div class="flex-grow flex items-center gap-2 item-ratio-part-group">
                        <label for="itemRatioPart-${item.id}" class="text-gray-700 text-lg">æ¯”ç‡ (æ•°):</label>
                        <input type="number" id="itemRatioPart-${item.id}" value="${item.ratioPart}" class="w-24 p-2 border rounded-md text-lg item-ratio-part-input">
                        <input type="range" id="itemRatioPartSlider-${item.id}" min="0" max="15" value="${item.ratioPart}" class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer item-ratio-part-slider">
                    </div>
                    <button class="remove-item-specific-btn px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors shadow-sm focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75" data-item-id="${item.id}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                    </button>
                `;
                itemsContainer.appendChild(itemDiv);

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ
                document.getElementById(`itemLabel-${item.id}`).addEventListener('input', calculate);
                document.getElementById(`itemQuantity-${item.id}`).addEventListener('input', (e) => {
                    document.getElementById(`itemQuantitySlider-${item.id}`).value = e.target.value;
                    calculate();
                });
                document.getElementById(`itemQuantitySlider-${item.id}`).addEventListener('input', (e) => {
                    document.getElementById(`itemQuantity-${item.id}`).value = e.target.value;
                    calculate();
                });
                document.getElementById(`itemPercentage-${item.id}`).addEventListener('input', (e) => {
                    document.getElementById(`itemPercentageSlider-${item.id}`).value = e.target.value;
                    calculate();
                });
                document.getElementById(`itemPercentageSlider-${item.id}`).addEventListener('input', (e) => {
                    document.getElementById(`itemPercentage-${item.id}`).value = e.target.value;
                    calculate();
                });
                document.getElementById(`itemRatioPart-${item.id}`).addEventListener('input', (e) => {
                    document.getElementById(`itemRatioPartSlider-${item.id}`).value = e.target.value;
                    calculate();
                });
                document.getElementById(`itemRatioPartSlider-${item.id}`).addEventListener('input', (e) => {
                    document.getElementById(`itemRatioPart-${item.id}`).value = e.target.value;
                    calculate();
                });

                // å€‹åˆ¥å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                const removeItemSpecificBtn = itemDiv.querySelector(`.remove-item-specific-btn`);
                removeItemSpecificBtn.addEventListener('click', (e) => {
                    const itemIdToRemove = parseInt(e.currentTarget.dataset.itemId);
                    if (items.length > 1) { // æœ€ä½1é …ç›®ã¯æ®‹ã™
                        items = items.filter(item => item.id !== itemIdToRemove);
                        renderItems(); // å†æç”»
                        calculate(); // å†è¨ˆç®—
                    } else {
                        showMessage('ã“ã‚Œä»¥ä¸Šé …ç›®ã‚’æ¸›ã‚‰ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚', 'error');
                    }
                });
            });
            updateUI(); // é …ç›®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¾Œã«UIã‚’æ›´æ–°
        }

        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function updateInputFieldFocusStyle(inputElement, isEditable) {
            inputElement.classList.remove('focus:ring-blue-500', 'focus:border-blue-500', 'focus:ring-gray-400', 'focus:border-gray-400');
            if (isEditable) {
                inputElement.classList.add('focus:ring-blue-500', 'focus:border-blue-500');
            } else {
                inputElement.classList.add('focus:ring-gray-400', 'focus:border-gray-400');
            }
        }

        // UIã®æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹ã‚’æ›´æ–°
        function updateUI() {
            // ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            modeButtons.forEach(button => {
                button.classList.remove('selected');
            });
            document.getElementById(`mode${currentMode}Btn`).classList.add('selected');

            // ç·é‡å…¥åŠ›ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®šï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ã€ç°è‰²æ ç·šï¼‰
            totalQuantityInput.readOnly = true;
            totalQuantityInput.classList.add('bg-gray-100');
            totalQuantityInput.classList.remove('border-blue-300');
            totalQuantityInput.classList.add('border-gray-300');
            totalQuantitySlider.disabled = true;
            totalQuantitySlider.classList.add('opacity-50', 'cursor-not-allowed');
            updateInputFieldFocusStyle(totalQuantityInput, false); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚æ›´æ–°

            const allPercentageGroups = document.querySelectorAll('.item-percentage-group');
            const allRatioPartGroups = document.querySelectorAll('.item-ratio-part-group');

            // Hide/Show ratio/percentage groups based on selection
            if (currentRatioInputType === 'percentage') {
                allPercentageGroups.forEach(group => group.style.display = 'flex');
                allRatioPartGroups.forEach(group => group.style.display = 'none');
            } else { // currentRatioInputType === 'ratio'
                allPercentageGroups.forEach(group => group.style.display = 'none');
                allRatioPartGroups.forEach(group => group.style.display = 'flex');
            }

            // Set readOnly/disabled based on current mode and input type for each item
            items.forEach((item, index) => {
                const quantityInput = document.getElementById(`itemQuantity-${item.id}`);
                const quantitySlider = document.getElementById(`itemQuantitySlider-${item.id}`);
                const percentageInput = document.getElementById(`itemPercentage-${item.id}`);
                const percentageSlider = document.getElementById(`itemPercentageSlider-${item.id}`);
                const ratioPartInput = document.getElementById(`itemRatioPart-${item.id}`);
                const ratioPartSlider = document.getElementById(`itemRatioPartSlider-${item.id}`); // New: Ratio Part Slider

                // Default all item inputs to readOnly
                quantityInput.readOnly = true;
                quantityInput.classList.add('bg-gray-100');
                quantitySlider.disabled = true;
                quantitySlider.classList.add('opacity-50', 'cursor-not-allowed');
                updateInputFieldFocusStyle(quantityInput, false);

                percentageInput.readOnly = true;
                percentageInput.classList.add('bg-gray-100');
                percentageSlider.disabled = true;
                percentageSlider.classList.add('opacity-50', 'cursor-not-allowed');
                updateInputFieldFocusStyle(percentageInput, false);

                ratioPartInput.readOnly = true;
                ratioPartInput.classList.add('bg-gray-100');
                ratioPartSlider.disabled = true; // New: Disable ratio part slider by default
                ratioPartSlider.classList.add('opacity-50', 'cursor-not-allowed'); // New: Add disabled style
                updateInputFieldFocusStyle(ratioPartInput, false);

                // Enable inputs based on mode and selected ratio type
                switch (currentMode) {
                    case 1: // ç·é‡ã¨å‰²åˆã‹ã‚‰é‡ã‚’ç®—å‡º
                        totalQuantityInput.readOnly = false;
                        totalQuantityInput.classList.remove('bg-gray-100', 'border-gray-300');
                        totalQuantityInput.classList.add('border-blue-300'); // é’ã„æ ç·šã«æˆ»ã™
                        totalQuantitySlider.disabled = false;
                        totalQuantitySlider.classList.remove('opacity-50', 'cursor-not-allowed');
                        updateInputFieldFocusStyle(totalQuantityInput, true); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚æ›´æ–°

                        if (currentRatioInputType === 'percentage') {
                            percentageInput.readOnly = false;
                            percentageInput.classList.remove('bg-gray-100');
                            percentageSlider.disabled = false;
                            percentageSlider.classList.remove('opacity-50', 'cursor-not-allowed');
                            updateInputFieldFocusStyle(percentageInput, true);
                        } else { // currentRatioInputType === 'ratio'
                            ratioPartInput.readOnly = false;
                            ratioPartInput.classList.remove('bg-gray-100');
                            ratioPartSlider.disabled = false; // New: Enable ratio part slider
                            ratioPartSlider.classList.remove('opacity-50', 'cursor-not-allowed'); // New: Remove disabled style
                            updateInputFieldFocusStyle(ratioPartInput, true);
                        }
                        break;
                    case 2: // å‰²åˆã¨1é …ç›®ã‹ã‚‰ä»–ã‚’ç®—å‡º
                        // Only the first item's quantity is editable
                        if (index === 0) {
                            quantityInput.readOnly = false;
                            quantityInput.classList.remove('bg-gray-100');
                            quantitySlider.disabled = false;
                            quantitySlider.classList.remove('opacity-50', 'cursor-not-allowed');
                            updateInputFieldFocusStyle(quantityInput, true);
                        }

                        if (currentRatioInputType === 'percentage') {
                            percentageInput.readOnly = false;
                            percentageInput.classList.remove('bg-gray-100');
                            percentageSlider.disabled = false;
                            percentageSlider.classList.remove('opacity-50', 'cursor-not-allowed');
                            updateInputFieldFocusStyle(percentageInput, true);
                        } else { // currentRatioInputType === 'ratio'
                            ratioPartInput.readOnly = false;
                            ratioPartInput.classList.remove('bg-gray-100');
                            ratioPartSlider.disabled = false; // New: Enable ratio part slider
                            ratioPartSlider.classList.remove('opacity-50', 'cursor-not-allowed'); // New: Remove disabled style
                            updateInputFieldFocusStyle(ratioPartInput, true);
                        }
                        break;
                    case 3: // å„é …ç›®ã‹ã‚‰ç·é‡ã¨å‰²åˆã‚’ç®—å‡º
                        quantityInput.readOnly = false;
                        quantityInput.classList.remove('bg-gray-100');
                        quantitySlider.disabled = false;
                        quantitySlider.classList.remove('opacity-50', 'cursor-not-allowed');
                        updateInputFieldFocusStyle(quantityInput, true);
                        // Percentage and RatioPart remain readOnly as they are outputs
                        break;
                }
            });
        }

        // æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function gcd(a, b) {
            return b === 0 ? a : gcd(b, a % b);
        }

        // æ•°å€¤ã®é…åˆ—ã‚’æ¯”ç‡ã«ç°¡ç•¥åŒ–ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function simplifyNumbersToRatio(numbers) {
            if (numbers.length === 0) return [];
            const nonZeroNumbers = numbers.filter(n => n > 0);
            if (nonZeroNumbers.length === 0) return numbers.map(() => 0); // å…¨ã¦0ãªã‚‰0ã®ã¾ã¾

            // å°æ•°ç‚¹ã‚’è€ƒæ…®ã™ã‚‹ãŸã‚ã€ä¸€æ—¦æ•´æ•°ã«å¤‰æ›ã—ã¦GCDã‚’è¨ˆç®—
            const scale = 1000; // ä¾‹: 3æ¡ã®å°æ•°ç‚¹ä»¥ä¸‹ã¾ã§è€ƒæ…®
            const scaledNumbers = numbers.map(n => Math.round(n * scale));

            let resultGcd = scaledNumbers[0];
            for (let i = 1; i < scaledNumbers.length; i++) {
                resultGcd = gcd(resultGcd, scaledNumbers[i]);
            }

            // å…ƒã®ã‚¹ã‚±ãƒ¼ãƒ«ã«æˆ»ã—ã¦ã€æœ€ã‚‚ç°¡å˜ãªæ•´æ•°æ¯”ç‡ã«ã™ã‚‹
            return numbers.map(n => (n === 0 ? 0 : Math.round(n * scale / resultGcd)));
        }

        // è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
        function calculate() {
            let totalQuantity = 0; // Will be read from input or calculated
            let inputTotalQuantity = 0;

            // Step 1: Read values from DOM for currently editable fields
            if (!totalQuantityInput.readOnly) {
                inputTotalQuantity = parseFloat(totalQuantityInput.value) || 0;
            }

            // Create temporary arrays to store current input values from DOM
            const currentQuantities = [];
            const currentPercentages = [];
            const currentRatioParts = [];

            items.forEach(item => {
                const quantityInput = document.getElementById(`itemQuantity-${item.id}`);
                const percentageInput = document.getElementById(`itemPercentage-${item.id}`);
                const ratioPartInput = document.getElementById(`itemRatioPart-${item.id}`);

                currentQuantities.push(parseFloat(quantityInput.value) || 0);
                currentPercentages.push(parseFloat(percentageInput.value) || 0);
                currentRatioParts.push(parseFloat(ratioPartInput.value) || 0);
            });

            // Step 2: Determine effective input values for the current mode
            let effectiveQuantities = [...currentQuantities]; // Quantities used for calculation
            let effectivePercentages = []; // Percentages used for calculation and chart
            let effectiveRatioParts = [...currentRatioParts]; // Ratio parts used for calculation

            let sumOfInputQuantities = 0;
            let sumOfInputPercentages = 0;
            let sumOfInputRatioParts = 0;

            // Populate effective inputs based on mode and current editable state
            switch (currentMode) {
                case 1: // ç·é‡ã¨å‰²åˆã‹ã‚‰é‡ã‚’ç®—å‡º
                    totalQuantity = inputTotalQuantity; // totalQuantity is an input
                    if (currentRatioInputType === 'percentage') {
                        effectivePercentages = [...currentPercentages];
                        sumOfInputPercentages = effectivePercentages.reduce((sum, val) => sum + val, 0);
                        if (sumOfInputPercentages !== 100 && sumOfInputPercentages !== 0) {
                            showMessage(`å‰²åˆã®åˆè¨ˆãŒ100%ã§ã¯ã‚ã‚Šã¾ã›ã‚“ (${sumOfInputPercentages.toFixed(2)}%)ã€‚è‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™ã€‚`, 'warning');
                            effectivePercentages = effectivePercentages.map(p => (p / sumOfInputPercentages) * 100);
                        }
                    } else { // currentRatioInputType === 'ratio'
                        effectiveRatioParts = [...currentRatioParts];
                        sumOfInputRatioParts = effectiveRatioParts.reduce((sum, val) => sum + val, 0);
                        if (sumOfInputRatioParts === 0) {
                            showMessage('æ¯”ç‡ã®åˆè¨ˆãŒ0ã§ã™ã€‚å„é …ç›®ã®æ¯”ç‡ã«0ã‚ˆã‚Šå¤§ãã„å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                            effectivePercentages = items.map(() => 0);
                        } else {
                            effectivePercentages = effectiveRatioParts.map(rp => (rp / sumOfInputRatioParts) * 100);
                        }
                    }
                    break;
                case 2: // å‰²åˆã¨1é …ç›®ã‹ã‚‰ä»–ã‚’ç®—å‡º
                    totalQuantity = 0; // totalQuantity is an output
                    effectiveQuantities[0] = currentQuantities[0]; // First item quantity is input

                    if (currentRatioInputType === 'percentage') {
                        effectivePercentages = [...currentPercentages];
                        sumOfInputPercentages = effectivePercentages.reduce((sum, val) => sum + val, 0);
                        if (sumOfInputPercentages !== 100 && sumOfInputPercentages !== 0) {
                            showMessage(`å‰²åˆã®åˆè¨ˆãŒ100%ã§ã¯ã‚ã‚Šã¾ã›ã‚“ (${sumOfInputPercentages.toFixed(2)}%)ã€‚è‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™ã€‚`, 'warning');
                            effectivePercentages = effectivePercentages.map(p => (p / sumOfInputPercentages) * 100);
                        }
                    } else { // currentRatioInputType === 'ratio'
                        effectiveRatioParts = [...currentRatioParts];
                        sumOfInputRatioParts = effectiveRatioParts.reduce((sum, val) => sum + val, 0);
                        if (sumOfInputRatioParts === 0) {
                            showMessage('æ¯”ç‡ã®åˆè¨ˆãŒ0ã§ã™ã€‚å„é …ç›®ã®æ¯”ç‡ã«0ã‚ˆã‚Šå¤§ãã„å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                            effectivePercentages = items.map(() => 0);
                        } else {
                            effectivePercentages = effectiveRatioParts.map(rp => (rp / sumOfInputRatioParts) * 100);
                        }
                    }
                    break;
                case 3: // å„é …ç›®ã‹ã‚‰ç·é‡ã¨å‰²åˆã‚’ç®—å‡º
                    totalQuantity = 0; // totalQuantity is an output
                    // effectiveQuantities are already populated from currentQuantities
                    sumOfInputQuantities = effectiveQuantities.reduce((sum, val) => sum + val, 0);
                    break;
            }

            // Step 3: Perform calculations using effective input values
            switch (currentMode) {
                case 1: // ç·é‡ã¨å‰²åˆã‹ã‚‰é‡ã‚’ç®—å‡º
                    items.forEach((item, index) => {
                        item.quantity = totalQuantity * (effectivePercentages[index] / 100);
                        item.percentage = effectivePercentages[index]; // Store calculated percentage
                        // Also calculate ratioPart for display if needed
                        if (totalQuantity > 0) {
                            const quantitiesForRatio = items.map(i => i.quantity);
                            const simplifiedRatioParts = simplifyNumbersToRatio(quantitiesForRatio);
                            item.ratioPart = simplifiedRatioParts[index];
                        } else {
                            item.ratioPart = 0;
                        }
                    });
                    break;
                case 2: // å‰²åˆã¨1é …ç›®ã‹ã‚‰ä»–ã‚’ç®—å‡º
                    const referenceQuantity = effectiveQuantities[0];
                    const referencePercentage = effectivePercentages[0];

                    if (referenceQuantity > 0 && referencePercentage > 0) {
                        totalQuantity = referenceQuantity / (referencePercentage / 100);
                        items.forEach((item, index) => {
                            if (index !== 0) { // Calculate quantity for other items
                                item.quantity = totalQuantity * (effectivePercentages[index] / 100);
                            }
                            item.percentage = effectivePercentages[index]; // Store calculated percentage
                            // Also calculate ratioPart for display if needed
                            if (totalQuantity > 0) {
                                const quantitiesForRatio = items.map(i => i.quantity);
                                const simplifiedRatioParts = simplifyNumbersToRatio(quantitiesForRatio);
                                item.ratioPart = simplifiedRatioParts[index];
                            } else {
                                item.ratioPart = 0;
                            }
                        });
                    } else {
                        totalQuantity = 0;
                        items.forEach((item, index) => {
                            item.quantity = 0;
                            item.percentage = effectivePercentages[index]; // Still store effective percentage
                            item.ratioPart = 0;
                        });
                    }
                    break;
                case 3: // å„é …ç›®ã‹ã‚‰ç·é‡ã¨å‰²åˆã‚’ç®—å‡º
                    totalQuantity = sumOfInputQuantities; // totalQuantity is calculated from input quantities

                    if (totalQuantity > 0) {
                        items.forEach((item, index) => {
                            item.quantity = effectiveQuantities[index]; // Store input quantity
                            item.percentage = (item.quantity / totalQuantity) * 100;
                        });
                        // Calculate ratioPart from quantities
                        const quantitiesForRatio = items.map(i => i.quantity);
                        const simplifiedRatioParts = simplifyNumbersToRatio(quantitiesForRatio);
                        items.forEach((item, index) => {
                            item.ratioPart = simplifiedRatioParts[index];
                        });
                    } else {
                        items.forEach((item, index) => {
                            item.quantity = effectiveQuantities[index]; // Store input quantity
                            item.percentage = 0;
                            item.ratioPart = 0;
                        });
                    }
                    break;
            }

            // Step 4: Update DOM for output fields
            // Update total quantity
            if (totalQuantityInput.readOnly) {
                totalQuantityInput.value = totalQuantity.toFixed(2);
                totalQuantitySlider.value = totalQuantity.toFixed(2);
            }

            items.forEach((item) => {
                const quantityInput = document.getElementById(`itemQuantity-${item.id}`);
                const quantitySlider = document.getElementById(`itemQuantitySlider-${item.id}`);
                const percentageInput = document.getElementById(`itemPercentage-${item.id}`);
                const percentageSlider = document.getElementById(`itemPercentageSlider-${item.id}`);
                const ratioPartInput = document.getElementById(`itemRatioPart-${item.id}`);
                const ratioPartSlider = document.getElementById(`itemRatioPartSlider-${item.id}`); // New: Ratio Part Slider

                if (quantityInput.readOnly) {
                    quantityInput.value = item.quantity.toFixed(2);
                    quantitySlider.value = item.quantity.toFixed(2);
                }
                if (percentageInput.readOnly) {
                    percentageInput.value = item.percentage.toFixed(2);
                    percentageSlider.value = item.percentage.toFixed(2);
                }
                if (ratioPartInput.readOnly) {
                    ratioPartInput.value = item.ratioPart.toFixed(0);
                    ratioPartSlider.value = item.ratioPart.toFixed(0); // New: Update slider value
                }
            });

            drawPieChart(items, totalQuantity);
        }

        // å††ã‚°ãƒ©ãƒ•æç”»
        function drawPieChart(data, total) {
            ctx.clearRect(0, 0, pieChartCanvas.width, pieChartCanvas.height);
            const centerX = pieChartCanvas.width / 2;
            const centerY = pieChartCanvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.7; // åŠå¾„ã‚’èª¿æ•´

            let startAngle = 0;
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#E7E9ED', '#8AC926', '#1982C4', '#6A4C93'
            ]; // é …ç›®ã”ã¨ã®è‰²

            // ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
            if (data.length === 0 || total === 0) {
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.fillStyle = '#E0E0E0'; // ç°è‰²
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#B0B0B0';
                ctx.stroke();
                selectedSliceInfo.textContent = 'ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                return;
            }

            // ã‚°ãƒ©ãƒ•æç”»ã«ä½¿ç”¨ã™ã‚‹å‰²åˆã®åˆè¨ˆã‚’è¨ˆç®— (å°æ•°ç‚¹èª¤å·®ã‚’è€ƒæ…®)
            let sumOfDisplayPercentages = data.reduce((sum, item) => sum + item.percentage, 0);

            // å‰²åˆã®åˆè¨ˆãŒ0ã®å ´åˆã®å‡¦ç†
            if (sumOfDisplayPercentages === 0) {
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.fillStyle = '#E0E0E0'; // ç°è‰²
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#B0B0B0';
                ctx.stroke();
                selectedSliceInfo.textContent = 'å‰²åˆã®åˆè¨ˆãŒ0ã§ã™ã€‚';
                return;
            }

            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ãŸã‚ã®ã‚¹ãƒ©ã‚¤ã‚¹æƒ…å ±ä¿å­˜
            pieChartCanvas.slices = [];

            // å„ã‚¹ãƒ©ã‚¤ã‚¹ã‚’æç”»
            data.forEach((item, index) => {
                // è¡¨ç¤ºç”¨ã®å‰²åˆã‚’æ­£è¦åŒ–
                const sliceAngle = (item.percentage / sumOfDisplayPercentages) * 2 * Math.PI;
                const endAngle = startAngle + sliceAngle;

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.closePath();
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();
                ctx.lineWidth = 1;
                ctx.strokeStyle = '#fff'; // ã‚¹ãƒ©ã‚¤ã‚¹é–“ã®å¢ƒç•Œç·š
                ctx.stroke();

                // ã‚¹ãƒ©ã‚¤ã‚¹æƒ…å ±ã‚’ä¿å­˜
                pieChartCanvas.slices.push({
                    startAngle: startAngle,
                    endAngle: endAngle,
                    label: item.label,
                    quantity: item.quantity,
                    percentage: item.percentage
                });

                // ãƒ†ã‚­ã‚¹ãƒˆãƒ©ãƒ™ãƒ« (ä¸­å¿ƒã‹ã‚‰å°‘ã—é›¢ã‚ŒãŸä½ç½®)
                const textAngle = startAngle + sliceAngle / 2;
                const textX = centerX + radius * 0.65 * Math.cos(textAngle);
                const textY = centerY + radius * 0.65 * Math.sin(textAngle);

                ctx.fillStyle = 'white';
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                if (item.percentage > 0) { // å‰²åˆãŒ0ã®å ´åˆã¯è¡¨ç¤ºã—ãªã„
                    ctx.fillText(`${item.percentage.toFixed(1)}%`, textX, textY);
                }

                startAngle = endAngle;
            });

            selectedSliceInfo.textContent = 'ã‚°ãƒ©ãƒ•ã®é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
        }

        // å††ã‚°ãƒ©ãƒ•ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        pieChartCanvas.addEventListener('click', (e) => {
            const rect = pieChartCanvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const centerX = pieChartCanvas.width / 2;
            const centerY = pieChartCanvas.height / 2;
            const dx = mouseX - centerX;
            const dy = mouseY - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const radius = Math.min(centerX, centerY) * 0.7;

            if (distance <= radius) {
                let angle = Math.atan2(dy, dx);
                if (angle < 0) angle += 2 * Math.PI; // 0ã‹ã‚‰2Ï€ã®ç¯„å›²ã«èª¿æ•´

                let foundSlice = false;
                // Fix: Check if pieChartCanvas.slices is defined before iterating
                if (pieChartCanvas.slices) {
                    for (const slice of pieChartCanvas.slices) {
                        if (angle >= slice.startAngle && angle < slice.endAngle) {
                            selectedSliceInfo.innerHTML = `
                                <p class="text-xl font-bold mb-2">${slice.label}</p>
                                <p>é‡: <span class="font-semibold text-blue-700">${slice.quantity.toFixed(2)}</span></p>
                                <p>å‰²åˆ: <span class="font-semibold text-blue-700">${slice.percentage.toFixed(2)}%</span></p>
                            `;
                            foundSlice = true;
                            break;
                        }
                    }
                }
                if (!foundSlice) {
                    selectedSliceInfo.textContent = 'ã‚°ãƒ©ãƒ•ã®é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
                }
            } else {
                selectedSliceInfo.textContent = 'ã‚°ãƒ©ãƒ•ã®é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
            }
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        mode1Btn.addEventListener('click', () => { currentMode = 1; updateUI(); calculate(); });
        mode2Btn.addEventListener('click', () => { currentMode = 2; updateUI(); calculate(); });
        mode3Btn.addEventListener('click', () => { currentMode = 3; updateUI(); calculate(); });

        radioPercentage.addEventListener('change', () => { currentRatioInputType = 'percentage'; updateUI(); calculate(); });
        radioRatio.addEventListener('change', () => { currentRatioInputType = 'ratio'; updateUI(); calculate(); });

        totalQuantityInput.addEventListener('input', calculate);
        totalQuantitySlider.addEventListener('input', () => {
            totalQuantityInput.value = totalQuantitySlider.value;
            calculate();
        });

        addItemBtn.addEventListener('click', () => {
            const newId = items.length > 0 ? Math.max(...items.map(item => item.id)) + 1 : 1;
            items.push({ id: newId, label: `é …ç›®${newId}`, quantity: 0, percentage: 0, ratioPart: 1 });
            renderItems();
            calculate();
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º/éè¡¨ç¤ºã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        helpButton.addEventListener('click', () => {
            helpModal.classList.remove('hidden');
        });

        closeModalButton.addEventListener('click', () => {
            helpModal.classList.add('hidden');
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‰ã˜ã‚‹
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                helpModal.classList.add('hidden');
            }
        });

        // åˆæœŸåŒ–
        initializeItems();
    </script>
</body>
</html>
